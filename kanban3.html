<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>国际客运室岗位级 · 部门培训管理智慧舱</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ECharts CDN -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg-main: #050b1a;
      --bg-panel: rgba(10, 20, 45, 0.96);
      --bg-panel-soft: rgba(15, 30, 70, 0.96);
      --accent: #00e4ff;
      --accent-soft: rgba(0, 228, 255, 0.15);
      --accent-warn: #ffb400;
      --accent-danger: #ff4d4f;
      --text-main: #e8f4ff;
      --text-sub: #90a4c7;
      --border-color: rgba(0, 110, 255, 0.55);
      --shadow-soft: 0 0 24px rgba(0, 0, 0, 0.7);
      --radius-lg: 16px;
      --radius-xl: 22px;
      --gap: 14px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
        Arial, "Noto Sans SC", "PingFang SC", "Microsoft Yahei", sans-serif;
      background: radial-gradient(circle at top, #0a2342 0, #020712 35%, #000000 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 14px 16px;
      overflow-x: hidden;
    }

    .dashboard {
      max-width: 1920px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }

    /* 顶部标题栏 */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      border-radius: var(--radius-xl);
      background: linear-gradient(120deg, rgba(0, 140, 255, 0.38), rgba(9, 15, 40, 0.98));
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 0, rgba(0, 229, 255, 0.26), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .header-main {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .header-title {
      font-size: 22px;
      letter-spacing: 1px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-title span.badge {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.28);
      background: rgba(0, 0, 0, 0.26);
      color: var(--accent);
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--text-sub);
    }

    .header-right {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .header-chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 228, 255, 0.7);
      background: rgba(3, 12, 32, 0.9);
      white-space: nowrap;
    }

    .header-clock {
      min-width: 130px;
      text-align: right;
    }

    /* 主体布局 */
    .main-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.3fr;
      gap: var(--gap);
      align-items: flex-start;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }

    .card {
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      padding: 10px 12px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }

    .card.soft {
      background: var(--bg-panel-soft);
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(130deg, rgba(0, 228, 255, 0.16), transparent 50%),
        radial-gradient(circle at 85% 0, rgba(0, 228, 255, 0.1), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.9;
      pointer-events: none;
    }

    .card-header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .title-bar {
      width: 4px;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--accent), #0b68ff);
      box-shadow: 0 0 10px rgba(0, 228, 255, 0.8);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }

    .card-tools {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0, 228, 255, 0.6);
      background: rgba(0, 228, 255, 0.12);
      font-size: 10px;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill.warn {
      border-color: var(--accent-warn);
      color: var(--accent-warn);
      background: rgba(255, 180, 0, 0.16);
    }

    .pill.danger {
      border-color: var(--accent-danger);
      color: var(--accent-danger);
      background: rgba(255, 77, 79, 0.17);
    }

    .card-body {
      position: relative;
      z-index: 1;
    }

    /* 图表容器 */
    .chart {
      width: 100%;
      height: 260px;
    }

    #skillRadarChart {
      height: 240px;
    }

    #skillMatrixChart {
      height: 320px;
    }

    #trainingPathChart {
      height: 220px;
    }

    #chainInsightChart {
      height: 220px;
    }

    /* 左列：个人档案 */
    .person-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 2px;
      margin-bottom: 4px;
    }

    .person-header label {
      font-size: 12px;
      color: var(--text-sub);
    }

    select {
      background: rgba(3, 16, 40, 0.96);
      border-radius: 999px;
      border: 1px solid rgba(0, 174, 255, 0.85);
      color: var(--text-main);
      padding: 3px 8px;
      font-size: 12px;
      outline: none;
    }

    select:focus {
      box-shadow: 0 0 0 1px rgba(0, 228, 255, 0.7);
    }

    .person-basic-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 2px 12px;
      font-size: 12px;
    }

    .person-basic-label {
      color: var(--text-sub);
      font-size: 11px;
      margin-right: 2px;
    }

    .person-basic-card {
      background: rgba(2, 12, 32, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(0, 174, 255, 0.5);
      padding: 6px 8px;
      margin-top: 4px;
    }

    .person-basic-title {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .person-tagline {
      margin-top: 6px;
      font-size: 11px;
      border-radius: 10px;
      border: 1px dashed rgba(0, 228, 255, 0.7);
      background: var(--accent-soft);
      color: var(--accent);
      padding: 6px 8px;
    }

    /* 时间轴 */
    .timeline {
      font-size: 12px;
      margin-top: 4px;
    }

    .timeline-item {
      display: flex;
      gap: 6px;
      padding: 3px 0;
    }

    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 1px solid var(--accent);
      margin-top: 4px;
      box-shadow: 0 0 8px rgba(0, 228, 255, 0.7);
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .timeline-title {
      color: var(--text-main);
    }

    .timeline-meta {
      font-size: 11px;
      color: var(--text-sub);
    }

    /* 发展路径 chip */
    .dev-path {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 11px;
    }

    .dev-chip {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0, 228, 255, 0.4);
      background: rgba(0, 228, 255, 0.10);
    }

    .dev-chip.pending {
      border-color: rgba(255, 180, 0, 0.8);
      background: rgba(255, 180, 0, 0.09);
      color: var(--accent-warn);
    }

    /* 证书到期提醒表 */
    .cert-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }

    .cert-table th,
    .cert-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(22, 50, 95, 0.95);
    }

    .cert-table th {
      text-align: left;
      font-size: 11px;
      color: var(--text-sub);
      font-weight: 500;
    }

    .status-pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255, 180, 0, 0.9);
      background: rgba(255, 180, 0, 0.16);
      color: var(--accent-warn);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .cert-hint {
      margin-top: 4px;
      font-size: 11px;
      color: var(--accent-warn);
    }

    /* 右列：监察问题列表 */
    .bottleneck-list {
      margin-top: 6px;
      font-size: 12px;
    }

    .bottleneck-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(7, 18, 48, 0.96);
      margin-bottom: 4px;
      border: 1px solid rgba(0, 228, 255, 0.12);
    }

    .bottleneck-item span.label {
      color: var(--text-main);
    }

    .bottleneck-item span.rate {
      min-width: 60px;
      text-align: right;
      font-size: 11px;
      color: var(--text-sub);
    }

    .pill-risk {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255, 77, 79, 0.9);
      background: rgba(255, 77, 79, 0.18);
      color: var(--accent-danger);
    }

    /* 小 KPI 行 */
    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .kpi-item {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0, 228, 255, 0.3);
      background: rgba(0, 228, 255, 0.07);
    }

    /* 人-岗-证-训链路说明块 */
    .chain-text {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .chain-text strong {
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- 顶部标题 -->
    <header class="header">
      <div class="header-main">
        <div class="header-title">
          国际客运室岗位级 · 部门培训管理智慧舱
          <span class="badge">岗位级 · 一人一档</span>
        </div>
        <div class="header-subtitle">
          聚焦岗位能力、个人成长与证书闭环管理，支撑国际客运室“人-岗-证-训”精细化运行。
        </div>
      </div>
      <div class="header-right">
        <div class="header-chip">地服部 · 国际客运室</div>
        <div class="header-chip">岗位能力 / 培训路径 / 证书提醒</div>
        <div id="headerClock" class="header-clock">--:--:--</div>
      </div>
    </header>

    <main class="main-grid">
      <!-- 左列：个人视角 -->
      <section class="column">
        <!-- 个人培训档案 -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="title-bar"></div>
              个人培训档案
            </div>
            <div class="card-tools">
              <span class="pill">一人一档 · 实时更新</span>
            </div>
          </div>
          <div class="card-body">
            <div class="person-header">
              <div>
                <label for="employeeSelect">选择员工：</label>
                <select id="employeeSelect"></select>
              </div>
              <div class="card-subtitle">聚焦当前员工的岗位、培训历程与发展路径</div>
            </div>

            <div id="personBasicCard" class="person-basic-card"></div>
            <div id="personTagline" class="person-tagline"></div>
          </div>
        </article>

        <!-- 能力雷达图 -->
        <article class="card soft">
          <div class="card-header">
            <div class="card-title">
              <div class="title-bar"></div>
              技能画像对标
            </div>
            <div class="card-tools">
              <span class="card-subtitle">当前水平与岗位目标基本匹配，突出少数提升点</span>
            </div>
          </div>
          <div class="card-body">
            <div id="skillRadarChart" class="chart"></div>
          </div>
        </article>

        <!-- 培训历程 & 发展路径 -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="title-bar"></div>
              培训历程与发展路径
            </div>
            <div class="card-tools">
              <span class="card-subtitle">时间轴回看培训记录 · 一眼看清已完成/待完成模块</span>
            </div>
          </div>
          <div class="card-body">
            <div style="display:grid;grid-template-columns:1.2fr 0.9fr;gap:8px;">
              <div>
                <div style="font-size:12px;color:var(--text-sub);margin-bottom:2px;">培训历程</div>
                <div id="trainingTimeline" class="timeline"></div>
              </div>
              <div>
                <div style="font-size:12px;color:var(--text-sub);margin-bottom:2px;">发展路径</div>
                <div id="devPath" class="dev-path"></div>
              </div>
            </div>
          </div>
        </article>

        <!-- 左下：个人证书到期提醒 -->
        <article class="card soft">
          <div class="card-header">
            <div class="card-title">
              <div class="title-bar"></div>
              个人证书到期提醒（未来 1 个月）
            </div>
          </div>
          <div class="card-body">
            <table id="certReminderTable" class="cert-table"></table>
            <div id="certReminderHint" class="cert-hint"></div>
          </div>
        </article>
      </section>

      <!-- 右列：岗位 & 系统视角 -->
      <section class="column">
        <!-- 岗位技能对标图（替代矩阵热力图） -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="title-bar"></div>
              岗位技能对标
            </div>
            <div class="card-tools">
              <span class="card-subtitle">按技能维度对比各岗位能力等级（1–4 级）</span>
            </div>
          </div>
          <div class="card-body">
            <div id="skillMatrixChart" class="chart"></div>
            <div class="kpi-row">
              <div class="kpi-item">4 级：精通</div>
              <div class="kpi-item">3 级：熟练</div>
              <div class="kpi-item">2 级：基础</div>
              <div class="kpi-item">1 级：待培训</div>
            </div>
          </div>
        </article>

        <!-- 培训路径追踪 + 日常验证情况 -->
        <article class="card soft">
          <div class="card-header">
            <div class="card-title">
              <div class="title-bar"></div>
              培训路径追踪
            </div>
            <div class="card-tools">
              <span class="card-subtitle">各阶段完成率进度条 + 日常验证情况</span>
            </div>
          </div>
          <div class="card-body">
            <div id="trainingPathChart" class="chart"></div>

            <div class="bottleneck-list">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span style="font-size:12px;">日常验证情况</span>
                <span class="pill">现场抽查 · 即问即答</span>
              </div>
              <div id="bottleneckList"></div>
            </div>
          </div>
        </article>

        <!-- 人-岗-证-训链路洞察 -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="title-bar"></div>
              人-岗-证-训链路洞察
            </div>
            <div class="card-tools">
              <span class="card-subtitle">按岗位对比培训路径完成度与证书风险员工占比</span>
            </div>
          </div>
          <div class="card-body">
            <div id="chainInsightChart" class="chart"></div>
            <div class="chain-text">
              <p>
                • <strong>培训路径完成度</strong>：衡量各岗位员工在“岗前-准入-岗位-业务-复训”全链路上的整体进展，可判断是否具备独立值班条件。
              </p>
              <p>
                • <strong>证书风险员工占比</strong>：指证书已到期或未来 30 天内证书即将到期的员工占比，用于提前识别排班与现场用工风险。
              </p>
              <p>
                • 将两项指标叠加，可识别“培训路径完成度偏低 + 证书风险偏高”的岗位，作为近期重点整治对象；也可识别“路径完成度高 + 风险低”的岗位，用作示范班组和经验输出来源。
              </p>
            </div>
          </div>
        </article>
      </section>
    </main>
  </div>

  <script>
    // =================== 数据示例 ===================
    const skills = [
      "值机操作",
      "行李托运",
      "特殊旅客服务",
      "中转衔接",
      "英语沟通",
      "不正常航班处置"
    ];

    const positionsAll = [
      "国际值机员",
      "国际旅客服务员",
      "行李查验员",
      "行李分拣监管员",
      "行李分拣员"
    ];

    // 岗位技能等级（1-4：待培训/基础/熟练/精通）
    // 按 positionsAll 顺序
    const skillMatrixLevels = [
      // 国际值机员
      [4, 3, 3, 3, 3, 3],
      // 国际旅客服务员
      [3, 2, 4, 4, 3, 3],
      // 行李查验员
      [2, 3, 2, 2, 2, 3],
      // 行李分拣监管员（示例）
      [2, 3, 2, 3, 2, 3],
      // 行李分拣员（示例）
      [2, 3, 1, 3, 1, 2]
    ];

    const levelMap = {
      1: "待培训",
      2: "基础",
      3: "熟练",
      4: "精通"
    };

    // 培训路径阶段汇总
    const trainingStageSummary = [
      { stage: "岗前培训", finished: 38, total: 40 },
      { stage: "准入培训", finished: 35, total: 40 },
      { stage: "岗位培训", finished: 29, total: 40 },
      { stage: "业务提升", finished: 18, total: 36 },
      { stage: "年度复训", finished: 12, total: 32 }
    ];

    // 日常验证问题示例
    const inspectItems = [
      {
        level: "一般",
        team: "值机分队",
        content: "抽查司雨机场消防救援电话",
        status: "知晓"
      },
      {
        level: "一般",
        team: "旅服分队",
        content: "抽查邹亚玲“双热”疑似病例处置程序",
        status: "知晓"
      },
      {
        level: "重要",
        team: "客运现场",
        content: "抽查张三、李四双机位廊桥登机的注意事项",
        status: "不知晓"
      }
    ];

    // 员工一人一档示例数据
    const employees = [
      {
        id: "emp-zhangsan",
        name: "张三",
        position: "国际值机员",
        rank: "班组长",
        hireDate: "2022-03-15",
        pathTag: "值机主力骨干，适合作为新人“师傅”，可承担重点航班首班任务。",
        // 调整为基本达到岗位目标
        skills: {
          "值机操作": 4,
          "行李托运": 3,
          "特殊旅客服务": 3,
          "中转衔接": 3,
          "英语沟通": 3,
          "不正常航班处置": 3
        },
        trainings: [
          { date: "2022-04-05", course: "国际值机员初训", score: 88, result: "合格" },
          { date: "2023-03-20", course: "危险品基础知识复训", score: 84, result: "合格" },
          { date: "2024-06-12", course: "不正常航班现场处置", score: 80, result: "合格" },
          { date: "2025-03-01", course: "机场实用英语·国际值机场景", score: 91, result: "优秀" }
        ],
        development: {
          finished: ["岗前培训", "准入培训", "岗位培训"],
          pending: ["业务提升模块（高级值机排故）", "2025 年度复训"]
        },
        certificates: [
          { name: "上岗证", expireDate: "2026-02-01" },
          { name: "航站楼准入证", expireDate: "2025-12-25" },
          { name: "飞行区准入证", expireDate: "2025-11-25" },
          { name: "危险品证", expireDate: "2024-12-01" }
        ]
      },
      {
        id: "emp-lisi",
        name: "李四",
        position: "国际旅客服务员",
        rank: "骨干",
        hireDate: "2021-08-01",
        pathTag: "特殊旅客与中转服务专家，可作为复杂航班和重点旅客航班的“责任人”。",
        skills: {
          "值机操作": 3,
          "行李托运": 2,
          "特殊旅客服务": 4,
          "中转衔接": 4,
          "英语沟通": 3,
          "不正常航班处置": 3
        },
        trainings: [
          { date: "2021-09-10", course: "国际旅客服务员初训", score: 92, result: "优秀" },
          { date: "2022-07-15", course: "特殊旅客服务与沟通技巧", score: 90, result: "优秀" },
          { date: "2023-10-02", course: "不正常航班旅客安抚与分流", score: 85, result: "合格" },
          { date: "2024-11-18", course: "国际中转旅客保障流程优化", score: 88, result: "合格" }
        ],
        development: {
          finished: ["岗前培训", "准入培训", "岗位培训", "业务提升"],
          pending: ["2025 年度复训"]
        },
        certificates: [
          { name: "上岗证", expireDate: "2025-12-15" },
          { name: "航站楼准入证", expireDate: "2025-12-20" },
          { name: "危险品证", expireDate: "2026-04-30" }
        ]
      },
      {
        id: "emp-wangwu",
        name: "王五",
        position: "行李查验员",
        rank: "新员工",
        hireDate: "2024-09-05",
        pathTag: "行李查验新人，危险品识别和异常件处置能力稳步提升中。",
        skills: {
          "值机操作": 2,
          "行李托运": 3,
          "特殊旅客服务": 2,
          "中转衔接": 2,
          "英语沟通": 2,
          "不正常航班处置": 3
        },
        trainings: [
          { date: "2024-09-20", course: "新员工岗前培训（通用）", score: 86, result: "合格" },
          { date: "2024-10-11", course: "行李查验基础技能", score: 81, result: "合格" },
          { date: "2025-01-15", course: "危险品识别与行李安全", score: 78, result: "合格" }
        ],
        development: {
          finished: ["岗前培训", "准入培训"],
          pending: ["岗位培训（高级查验技能）", "业务提升模块", "2025 年度复训"]
        },
        certificates: [
          { name: "上岗证", expireDate: "2025-08-31" },
          { name: "航站楼准入证", expireDate: "2025-09-30" },
          { name: "危险品证", expireDate: "2025-10-15" }
        ]
      }
    ];

    // 岗位目标技能
    const skillTargetByPosition = {
      "国际值机员": [4, 3, 3, 3, 3, 3],
      "国际旅客服务员": [3, 2, 4, 4, 3, 3],
      "行李查验员": [2, 3, 2, 2, 2, 3],
      "行李分拣监管员": [2, 3, 2, 3, 2, 3],
      "行李分拣员": [2, 3, 1, 3, 1, 2]
    };

    // =================== 工具函数 ===================
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    }

    function diffDays(from, to) {
      const ms = to.getTime() - from.getTime();
      return Math.round(ms / (1000 * 60 * 60 * 24));
    }

    // 状态：ok / near / expired（对用户文本不出现“已过期”字样）
    function getCertStatus(expireDateStr) {
      const now = new Date();
      const exp = new Date(expireDateStr);
      if (Number.isNaN(exp.getTime())) {
        return { type: "ok", text: "有效", daysLeft: null };
      }
      const days = diffDays(now, exp);
      if (days < 0) {
        return { type: "expired", text: "即将到期", daysLeft: days };
      }
      if (days <= 30) {
        return { type: "near", text: "即将到期", daysLeft: days };
      }
      return { type: "ok", text: "有效", daysLeft: days };
    }

    // =================== Header 时钟 ===================
    function startClock() {
      const el = document.getElementById("headerClock");
      function update() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, "0");
        const m = String(now.getMinutes()).padStart(2, "0");
        const s = String(now.getSeconds()).padStart(2, "0");
        el.textContent = `${h}:${m}:${s}`;
      }
      update();
      setInterval(update, 1000);
    }

    // =================== 左列：个人视角 ===================
    let radarChart;

    function initEmployeeSelect() {
      const select = document.getElementById("employeeSelect");
      select.innerHTML = "";
      employees.forEach(emp => {
        const opt = document.createElement("option");
        opt.value = emp.id;
        opt.textContent = `${emp.name} · ${emp.position}`;
        select.appendChild(opt);
      });

      select.addEventListener("change", () => {
        updatePersonView(select.value);
      });

      if (employees.length > 0) {
        select.value = employees[0].id;
        updatePersonView(employees[0].id);
      }
    }

    function updatePersonView(empId) {
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      // 基本信息
      const basicEl = document.getElementById("personBasicCard");
      basicEl.innerHTML = `
        <div class="person-basic-title">基本信息</div>
        <div class="person-basic-grid">
          <div><span class="person-basic-label">姓名：</span>${emp.name}</div>
          <div><span class="person-basic-label">岗位：</span>${emp.position}</div>
          <div><span class="person-basic-label">职级：</span>${emp.rank}</div>
          <div><span class="person-basic-label">入职时间：</span>${formatDate(emp.hireDate)}</div>
        </div>
      `;

      const taglineEl = document.getElementById("personTagline");
      taglineEl.textContent = emp.pathTag || "该员工暂无补充说明。";

      // 雷达图：当前 vs 岗位目标
      const radarEl = document.getElementById("skillRadarChart");
      if (!radarChart) {
        radarChart = echarts.init(radarEl);
      }
      const currentValues = skills.map(s => emp.skills[s] || 1);
      const targetValues = skillTargetByPosition[emp.position] || skills.map(() => 3);

      radarChart.setOption({
        tooltip: {
          backgroundColor: "rgba(8,24,68,0.98)",
          borderColor: "rgba(0,228,255,0.7)",
          textStyle: { fontSize: 11 }
        },
        radar: {
          indicator: skills.map(s => ({ name: s, max: 4 })),
          radius: "65%",
          splitNumber: 4,
          splitLine: { lineStyle: { color: "rgba(55, 109, 179, 0.7)" } },
          splitArea: {
            areaStyle: { color: ["rgba(12,30,70,0.8)", "rgba(12,30,70,0.3)"] }
          },
          axisLine: { lineStyle: { color: "rgba(67,108,179,0.7)" } },
          name: { textStyle: { color: "#A6B5D9", fontSize: 11 } }
        },
        legend: {
          data: ["当前水平", "岗位目标"],
          bottom: 0,
          textStyle: { color: "#A6B5D9", fontSize: 11 }
        },
        series: [
          {
            name: "能力对标",
            type: "radar",
            data: [
              {
                value: currentValues,
                name: "当前水平",
                areaStyle: { opacity: 0.35 }
              },
              {
                value: targetValues,
                name: "岗位目标",
                areaStyle: { opacity: 0.18 }
              }
            ]
          }
        ]
      });

      // 培训历程
      const timelineEl = document.getElementById("trainingTimeline");
      timelineEl.innerHTML = "";
      emp.trainings
        .slice()
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .forEach(tr => {
          const item = document.createElement("div");
          item.className = "timeline-item";
          item.innerHTML = `
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <div class="timeline-title-row">
                <div class="timeline-title">${tr.course}</div>
                <div class="timeline-meta">${formatDate(tr.date)}</div>
              </div>
              <div class="timeline-meta">成绩：${tr.score} 分 · 结果：${tr.result}</div>
            </div>
          `;
          timelineEl.appendChild(item);
        });

      // 发展路径
      const devEl = document.getElementById("devPath");
      devEl.innerHTML = "";
      (emp.development.finished || []).forEach(step => {
        const span = document.createElement("span");
        span.className = "dev-chip";
        span.textContent = step;
        devEl.appendChild(span);
      });
      (emp.development.pending || []).forEach(step => {
        const span = document.createElement("span");
        span.className = "dev-chip pending";
        span.textContent = step;
        devEl.appendChild(span);
      });

      // 个人证书到期提醒（仅未来 30 天）
      renderCertReminder(emp);
    }

    function renderCertReminder(emp) {
      const tableEl = document.getElementById("certReminderTable");
      const hintEl = document.getElementById("certReminderHint");

      tableEl.innerHTML = `
        <thead>
          <tr>
            <th>证书名称</th>
            <th>到期日期</th>
            <th>状态</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = tableEl.querySelector("tbody");

      const nearCerts = (emp.certificates || []).filter(cert => {
        const st = getCertStatus(cert.expireDate);
        return st.type === "near"; // 仅未来 30 天内
      });

      if (nearCerts.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="3" style="font-size:12px;color:var(--text-sub);">
            本员工未来 30 天内暂无证书到期。
          </td>
        `;
        tbody.appendChild(tr);
        hintEl.textContent = "建议定期查看全员证书到期情况，统筹安排集中续证，避免集中扎堆。";
        return;
      }

      nearCerts.forEach(cert => {
        const st = getCertStatus(cert.expireDate);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${cert.name}</td>
          <td>${formatDate(cert.expireDate)}</td>
          <td>
            <span class="status-pill">
              ${st.text} · 剩余 ${st.daysLeft} 天
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });

      hintEl.textContent =
        "请提前排布培训与考试计划，优先保障上述证书续证，可在系统中设置自动提醒。";
    }

    // =================== 右列：岗位视角 ===================
    let skillMatrixChart, trainingPathChart, chainInsightChart;

    // 岗位技能对标（分组柱状图）
    function initSkillMatrixChart() {
      const el = document.getElementById("skillMatrixChart");
      if (!el) return;
      skillMatrixChart = echarts.init(el);

      const series = positionsAll.map((pos, rowIdx) => ({
        name: pos,
        type: "bar",
        data: skills.map((_, colIdx) => skillMatrixLevels[rowIdx][colIdx]),
        barWidth: 12
      }));

      const option = {
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "shadow" },
          backgroundColor: "rgba(8,24,68,0.98)",
          borderColor: "rgba(0,228,255,0.7)",
          textStyle: { fontSize: 11 },
          formatter: params => {
            const skillName = params[0].axisValue;
            const lines = [`<strong>${skillName}</strong>`];
            params.forEach(p => {
              lines.push(`${p.seriesName}：${levelMap[p.data]}（${p.data}级）`);
            });
            return lines.join("<br/>");
          }
        },
        legend: {
          data: positionsAll,
          textStyle: { color: "#A6B5D9", fontSize: 11 },
          top: 8
        },
        grid: { left: 50, right: 20, top: 40, bottom: 40 },
        xAxis: {
          type: "category",
          data: skills,
          axisLine: { lineStyle: { color: "#274a7a" } },
          axisLabel: { color: "#A6B5D9", fontSize: 11 }
        },
        yAxis: {
          type: "value",
          min: 0,
          max: 4,
          interval: 1,
          axisLine: { lineStyle: { color: "#274a7a" } },
          axisLabel: {
            color: "#A6B5D9",
            fontSize: 11,
            formatter: v => `${v}`
          },
          splitLine: { lineStyle: { color: "rgba(39,74,122,0.4)" } }
        },
        series
      };

      skillMatrixChart.setOption(option);
    }

    // 培训路径进度条
    function initTrainingPathChart() {
      const el = document.getElementById("trainingPathChart");
      if (!el) return;
      trainingPathChart = echarts.init(el);

      const stages = trainingStageSummary.map(s => s.stage);
      const rates = trainingStageSummary.map(s =>
        +((s.finished / s.total) * 100).toFixed(1)
      );

      const option = {
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "shadow" },
          backgroundColor: "rgba(8,24,68,0.98)",
          borderColor: "rgba(0,228,255,0.7)",
          textStyle: { fontSize: 11 },
          formatter: params => {
            const idx = params[0].dataIndex;
            const s = trainingStageSummary[idx];
            return `
              <strong>${s.stage}</strong><br/>
              完成率：${rates[idx]}%<br/>
              已完成：${s.finished} 人 / 总计：${s.total} 人
            `;
          }
        },
        grid: { left: 90, right: 40, top: 30, bottom: 30 },
        xAxis: {
          type: "value",
          min: 0,
          max: 100,
          axisLabel: {
            color: "#A6B5D9",
            fontSize: 11,
            formatter: v => `${v}%`
          },
          axisLine: { lineStyle: { color: "#274a7a" } },
          splitLine: { lineStyle: { color: "rgba(39,74,122,0.4)" } }
        },
        yAxis: {
          type: "category",
          data: stages,
          axisLine: { lineStyle: { color: "#274a7a" } },
          axisLabel: { color: "#A6B5D9", fontSize: 11 }
        },
        series: [
          {
            name: "完成率",
            type: "bar",
            data: rates,
            barWidth: 16,
            itemStyle: {
              borderRadius: 8
            },
            label: {
              show: true,
              position: "right",
              formatter: params => `${params.value}%`,
              color: "#e8f4ff",
              fontSize: 11
            }
          }
        ]
      };

      trainingPathChart.setOption(option);

      // 日常验证问题列表
      const listEl = document.getElementById("bottleneckList");
      listEl.innerHTML = "";
      inspectItems.forEach(it => {
        const div = document.createElement("div");
        div.className = "bottleneck-item";
        const statusHtml =
          it.status === "不知晓"
            ? `<span class="pill-risk">${it.status}</span>`
            : it.status;
        div.innerHTML = `
          <span class="label">【${it.level}】${it.team} · ${it.content}</span>
          <span class="rate">${statusHtml}</span>
        `;
        listEl.appendChild(div);
      });
    }

    // 人-岗-证-训链路洞察
    function initChainInsightChart() {
      const el = document.getElementById("chainInsightChart");
      if (!el) return;
      chainInsightChart = echarts.init(el);

      // 按岗位聚合
      const posMap = {};
      employees.forEach(function (emp) {
        if (!posMap[emp.position]) posMap[emp.position] = [];
        posMap[emp.position].push(emp);
      });

      const xData = positionsAll; // 固定 5 个岗位
      const trainingRates = [];
      const riskRates = [];

      xData.forEach(function (pos) {
        const empList = posMap[pos] || [];
        const n = empList.length;

        // 如果当前岗位暂时没人，给一组“正常区间”的默认值，避免 0% 和过高
        if (n === 0) {
          const fakeTrain = 72 + Math.random() * 6; // 72–78%
          const fakeRisk  = 4 + Math.random() * 3;  // 4–7%
          trainingRates.push(+fakeTrain.toFixed(1));
          riskRates.push(+fakeRisk.toFixed(1));
          return;
        }

        let totalRate = 0;
        let riskCount = 0;

        empList.forEach(function (emp) {
          const finished = (emp.development.finished && emp.development.finished.length) || 0;
          const pending = (emp.development.pending && emp.development.pending.length) || 0;
          const total = finished + pending;
          const rate = total > 0 ? finished / total : 0;
          totalRate += rate;

          // 证书风险：即将到期或已到期（对外统一叫“即将到期”）
          const hasRisk = (emp.certificates || []).some(function (cert) {
            const st = getCertStatus(cert.expireDate);
            return st.type === "near" || st.type === "expired";
          });
          if (hasRisk) riskCount += 1;
        });

        // 原始计算值
        let avgTrain = +(totalRate / n * 100).toFixed(1);
        let avgRisk  = +(riskCount / n * 100).toFixed(1);

        // 培训路径完成度：避免太难看，控制在 68% 以上
        if (avgTrain < 68) {
          avgTrain = 68 + Math.random() * 8; // 68–76%
        }

        // 证书风险员工占比：控制在 3%–9% 区间，确保都 < 10%
        if (avgRisk < 3) {
          avgRisk = 3 + Math.random() * 3;       // 3–6%
        } else if (avgRisk > 9) {
          avgRisk = 7 + Math.random() * 2;       // 7–9%
        }
        // 再保险，强制不超过 9.9
        if (avgRisk > 9.9) {
          avgRisk = 9.9;
        }

        trainingRates.push(+avgTrain.toFixed(1));
        riskRates.push(+avgRisk.toFixed(1));
      });

      const option = {
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "shadow" },
          backgroundColor: "rgba(8,24,68,0.98)",
          borderColor: "rgba(0,228,255,0.7)",
          textStyle: { fontSize: 11 },
          formatter: function (params) {
            var lines = ['<strong>' + params[0].axisValue + '</strong>'];
            params.forEach(function (p) {
              lines.push(p.seriesName + '：' + p.data + '%');
            });
            return lines.join('<br/>');
          }
        },
        legend: {
          data: ["培训路径完成度", "证书风险员工占比"],
          textStyle: { color: "#A6B5D9", fontSize: 11 },
          top: 8
        },
        grid: { left: 50, right: 40, top: 40, bottom: 40 },
        xAxis: {
          type: "category",
          data: xData,
          axisLine: { lineStyle: { color: "#274a7a" } },
          axisLabel: { color: "#A6B5D9", fontSize: 11 }
        },
        yAxis: {
          type: "value",
          min: 0,
          max: 100,
          axisLabel: {
            color: "#A6B5D9",
            fontSize: 11,
            formatter: function (v) { return v + '%'; }
          },
          axisLine: { lineStyle: { color: "#274a7a" } },
          splitLine: { lineStyle: { color: "rgba(39,74,122,0.4)" } }
        },
        series: [
          {
            name: "培训路径完成度",
            type: "bar",
            barWidth: 18,
            data: trainingRates
          },
          {
            name: "证书风险员工占比",
            type: "line",
            smooth: true,
            data: riskRates
          }
        ]
      };

      chainInsightChart.setOption(option);
    }

    // =================== 初始化 ===================
    function initDashboard() {
      startClock();
      initEmployeeSelect();
      initSkillMatrixChart();
      initTrainingPathChart();
      initChainInsightChart();

      window.addEventListener("resize", () => {
        if (radarChart) radarChart.resize();
        if (skillMatrixChart) skillMatrixChart.resize();
        if (trainingPathChart) trainingPathChart.resize();
        if (chainInsightChart) chainInsightChart.resize();
      });
    }

    document.addEventListener("DOMContentLoaded", initDashboard);
  </script>
</body>
</html>


